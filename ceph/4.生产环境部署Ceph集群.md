## 背景介绍

之前一直在使用云产品, 包括服务器/云盘等等, 自己对于自建机房的技术栈不是很了解, 正好目前的公司使用的是Ceph分布式存储, 所以有机会去深入学习了一下, 这里记录一下安装的过程.



## Ceph简介

Ceph可以提供块存储(RBD), 对象存储(RADOSGW兼容S3), 文件系统存储(CEPHFS)等, 高可用, 可扩展, 成熟. 

<img width="700" height="297" alt="Image" src="https://github.com/user-attachments/assets/37a37cee-ad54-4722-8578-837b10a65a92" />

<img width="772" height="468" alt="Image" src="https://github.com/user-attachments/assets/f4865762-1cb5-4721-b2a1-18cd30d6ac49" />

**一句话总结就是: 一站式企业级存储解决方案!**



## 服务器信息

|  主机名   |     IP地址     |
| :-------: | :------------: |
| server131 | 192.168.78.131 |
| server132 | 192.168.78.132 |
| server133 | 192.168.78.133 |



操作系统选择RockyLinux9.6, 因为只是为了验证功能, 所以只使用了3个虚拟机, 并且monitor和OSD都部署在一起了, 真正生产使用的话monitor一般会跟OSD区分开.

## 版本选择



一般生产建议选择次新版, 并且一定是LTS版本.  我在本地使用RockyLinux9.6测试的时候, 安装新版本添加OSD总是报错, 咨询了ChatGPT也没有解决, 只能使用pacific(16)版本的才没问题, 这次我就使用16.2.15版本来做一个示例.

## 组件介绍

|  组件   | 是否必选 |                             作用                             |
| :-----: | :------: | :----------------------------------------------------------: |
| Monitor |   必选   | 通过Paxos协议组成集群对外提供高可用地址, 类似于Redis的Sentinel模式, 一般3个节点即可 |
|   OSD   |   必选   | 每一个数据盘会启动一个OSD进程, 用于处理跟磁盘的交互, 是Ceph最核心的组件 |
| Manager |   必选   | 提供Dashboard/监控等一些管理的能力, 一般2个节点就可以, 一主一备 |
|   MDS   |  非必选  | CephFS服务依赖的元数据服务。负责保存文件系统的元数据，管理目录结构, 如果不使用CephFS可以不安装 |
|   RGW   |  非必选  | 提供兼容S3的Restful API, 如果不需要对象存储功能可以不用安装  |

## 部署方式

官方推荐的部署方式为Cephadm, Cephadm依赖Python3和Docker(或者podman).



## 服务器配置

#### 修改主机名

这一步很关键, 因为Ceph的crush算法会把主机名当做一个因子, 为了把多副本的数据尽量打散, 所有主机名都一样的话会导致Ceph把多副本的数据都集中放到某一个服务器上的OSD里面, 这样该服务器出问题的时候就会影响服务.

```
# hostnamectl set-hostname server131
# hostnamectl set-hostname --static server131
```

## 时间同步

使用默认RockyLinux的时间同步地址的话直接加入开机自启就行.

```
systemctl restart chronyd.service
systemctl enable chronyd.service
```

当然也可以加上阿里云的时间同步服务器, 参考chrony加入阿里云ntp源, 参考 https://help.aliyun.com/zh/ecs/user-guide/alibaba-cloud-ntp-server/#c731489b76nog

## 网络配置

包括固定IP和自定义DNS配置

```
[root@server132 system-connections]# pwd
/etc/NetworkManager/system-connections
[root@server132 system-connections]# cat ens160.nmconnection
[connection]
id=ens160
uuid=d4326a73-ab2a-3034-bd29-848c6bfe7247
type=ethernet
autoconnect-priority=-999
interface-name=ens160
timestamp=1760539170

[ethernet]

[ipv4]
method=manual
address1=192.168.78.132/24
gateway=192.168.78.2
dns=223.5.5.5;114.114.114.114

[ipv6]
addr-gen-mode=eui64
method=auto

[proxy]
```



#### 配置hosts

为了集群稳定, 推荐写hosts文件:

```
192.168.78.131 server131
192.168.78.132 server132
192.168.78.133 server133
```



#### 关闭防火墙/SELinux

```
systemctl stop firewalld.service
systemctl disable firewalld.service
systemctl status firewalld.service

setenforce 0

sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config

grep SELINUX  /etc/selinux/config




```



#### 关闭swap

swap性能较低, 不推荐.

```
swapoff -a
```



#### 调整最大文件描述符

```
vim /etc/security/limits.conf

*        soft    nofile    65535
*        hard    nofile    65535

```

验证方式:

```
ulimit -n
```

#### 更换阿里云yum源

```
# 参考网址 https://developer.aliyun.com/mirror/rockylinux

sed -e 's|^mirrorlist=|#mirrorlist=|g' \
    -e 's|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g' \
    -i.bak \
    /etc/yum.repos.d/rocky-*.repo

yum makecache

```



#### 安装一些必要的软件

```
yum install -y python3-jinja2  python3-pyyaml lvm2 -y 

yum install epel-release -y 

yum install htop -y 
```





## 部署过程

#### 安装Docker/Podman

参考 https://developer.aliyun.com/mirror/docker-ce

这里安装的podman:

```
yum install podman -y
```



#### 安装cephadm

第一个节点上安装cephadm命令即可.

```
# yum search release-ceph
Last metadata expiration check: 0:56:49 ago on Thu Sep 18 17:22:40 2025.
================================================================ Name Matched: release-ceph =================================================================
centos-release-ceph-pacific.noarch : Ceph Pacific packages from the CentOS Storage SIG repository
centos-release-ceph-quincy.noarch : Ceph Quincy packages from the CentOS Storage SIG repository
centos-release-ceph-reef.noarch : Ceph Reef packages from the CentOS Storage SIG repository
centos-release-ceph-squid.noarch : Ceph Squid packages from the CentOS Storage SIG repository


# yum install centos-release-ceph-pacific.noarch -y

# yum install -y python3-jinja2  python3-pyyaml lvm2 -y 

# yum install cephadm -y

# 验证是否安装成功

# cephadm version
```



#### 安装ceph相关工具

在第一个节点安装即可:

```
# 默认情况下执行如下命令会安装跟epel中的最新的那个版本, 我写文档的时候是19.2.3, 不过在RockyLinux9.5系统里面
# 会报错, 提示OpenSSL版本过低, 依赖3.4.0, 系统安装的是3.0.2版本, 看了网上, 说RockyLinux9.7会升级到
# OpenSSL3.5 LTS版本, 目前可以采用下面的方式安装一个适合系统的版本, 也就是19.2.2
# yum  install ceph-common
# 如下是安装适合系统的软件, 而不是最新的版本
# yum  install ceph-common --nobest
```



#### 创建ceph集群

```Shell
# cephadm bootstrap --mon-ip *<第一个Monitor节点的IP>*
cephadm bootstrap --mon-ip 192.168.78.131
```

执行上述命令以后, 会在第一个节点上安装该集群, 剩余的节点都是后续添加的, 集群初始化以后会有一个Dashboard的地址和账号密码, 需要登录并修改新的账号密码, 地址一般是192.168.78.131:8443.

#### 添加Host节点

添加公钥, cephadm会通过ssh远程执行命令.

```Shell
ssh-copy-id -f -i /etc/ceph/ceph.pub root@server132
ssh-copy-id -f -i /etc/ceph/ceph.pub root@server133
```

告诉集群新节点, labels根据实际情况决定是否添加, ceph的label跟K8s的类似, 一般用不到, 通过主机名来区别节点就够了:

```Shell
# ceph orch host add server132 192.168.78.132 --labels _admin
ceph orch host add server132 192.168.78.132
ceph orch host add server133 192.168.78.133
[root@server131 .ssh]# ceph orch host ls
HOST       ADDR            LABELS  STATUS
server131  192.168.78.131  _admin
server132  192.168.78.132
server133  192.168.78.133
3 hosts in cluster
```

到此为止, 集群其实已经安装完毕了, 剩下的就是添加磁盘, 正常的运维和使用集群了.



#### 添加OSD

1. 添加磁盘注意不要格式化, 直接加一个裸磁盘即可
2. ceph支持配置自动发现磁盘后加入OSD, 但是生产不太建议开启, 还是手工操作预期比较稳定, 测试环境可以开启, Dashboard会提示开启.
3. 这里只写手工加入OSD的方式

```
# 1. 首先保证lsblk能够看到新加入的磁盘

# 2. 查看ceph探测到的磁盘, 状态为Available才可以加入
[root@server131 ~]# ceph orch device ls
HOST       PATH      TYPE  DEVICE ID                                                 SIZE  AVAILABLE  REFRESHED  REJECT REASONS
server131  /dev/sda  hdd   ATA_VMware_Virtual_SATA_Hard_Drive_00000000000000000001  10.0G  Yes        19s ago

# 3. 加入OSD
ceph orch daemon add osd server131:/dev/sda
```





## 参考

* https://www.cnblogs.com/gustabm/p/17663966.html
* https://www.cnblogs.com/liugp/p/17018394.html





















