## èƒŒæ™¯ä»‹ç»



æœ€è¿‘åœ¨æ‰¾å·¥ä½œ, æ²¡äº‹å„¿çš„æ—¶å€™é¡ºä¾¿å­¦ä¹ ä¸€ä¸‹Kubernetesçš„ä¸€äº›å†…å®¹, ä¸å¾—ä¸è¯´ChatGPTæ˜¯çœŸçš„å¤ªå¼ºå¤§äº†, ä½ åªè¦é—®çš„æœ‰æ°´å¹³, ä»–çš„å›ç­”å‡ ä¹æ˜¯ä¸­ä¸Šæ°´å¹³çš„, æˆ‘ç»“åˆChatGPTå­¦ä¹ äº†ä¸€ä¸‹Kubernetesçš„CRDå’ŒOperator, åœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹.



## ä»€ä¹ˆæ˜¯CRDå’ŒOperator



Kubernetesæœ¬èº«çš„èµ„æºæ¯”å¦‚Pod/Deployment/Service/StatefulSetç­‰, åœ¨é‡åˆ°æ¯”è¾ƒå¤æ‚çš„æœåŠ¡éƒ¨ç½²çš„æ—¶å€™ä¼šæœ‰ä¸€äº›ä¸å¤ªå¥½ç»´æŠ¤, æ‰€ä»¥è¿™æ—¶å€™å°±ä¼šç”¨åˆ°CRD, CRD çš„å…¨ç§°æ˜¯ **CustomResourceDefinitionï¼ˆè‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼‰**ã€‚å®ƒå…è®¸ä½ åœ¨ Kubernetes ä¸­â€œè‡ªå®šä¹‰ä¸€ç§èµ„æºç±»å‹â€ã€‚è¿™æ ·ä½ å°±ä¸ç”¨ä¿®æ”¹Kubernetesçš„ä»£ç äº†, è¿™ä¹Ÿæ˜¯Kubernetesæ‰©å±•æ€§çš„ä¸€ç§ä½“ç°. æˆ‘è‡ªå·±çœ‹è§ä½¿ç”¨åœºæ™¯æ¯”è¾ƒå¤šçš„æ˜¯ä¸€äº›å¤æ‚åº”ç”¨çš„éƒ¨ç½², æ¯”å¦‚MySQLCluster, Prometheus, ElasticSearché›†ç¾¤ç­‰.



ä¸€å¥è¯è¯´, CRD æ˜¯ä½ å‘ Kubernetes æ³¨å…¥**æ–°èµ„æºç±»å‹**çš„ä¸€ç§æœºåˆ¶ï¼Œè®© K8s ä¸å†åªæ˜¯ç®¡ç† Pod/Serviceï¼Œè€Œæ˜¯èƒ½ç®¡ç†**ä½ å®šä¹‰çš„ä¸€åˆ‡èµ„æºç±»å‹**ã€‚



ä¸€ä¸ªCRDçš„ç¤ºä¾‹å¦‚ä¸‹:



```yaml

apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: apps.example.com
spec:
  group: example.com
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                image:
                  type: string
                replicas:
                  type: integer
  scope: Namespaced
  names:
    plural: apps
    singular: app
    kind: MyApp
    shortNames:
    - ap


```



å®šä¹‰ä¸€ä¸ªCRDå…¶å®åªæ˜¯å‘Šè¯‰Kubernetesé›†ç¾¤, åˆ›å»ºäº†ä¸€ä¸ªè·ŸPod/Deploymentç­‰ç›¸ä¼¼çš„ä¸€ç§æ–°èµ„æºç±»å‹, è¿™æ ·å°±å¯ä»¥æŒ‰ç…§Kubernetesçš„æ–¹å¼å®šä¹‰ä½¿ç”¨äº†, ä½†æ˜¯Kubernetesæ²¡æœ‰é“¶å¼¹, è„æ´»ç´¯æ´»è¿˜æ˜¯éœ€è¦è‡ªå·±åšçš„.



æˆ‘ç†è§£Operatorå°±æ˜¯ä¸€ç»„CRD+Controllers, CRDåªæ˜¯å°†ä¸€äº›å¤æ‚çš„ä»»åŠ¡æš´éœ²ä¸€äº›ç®€å•å¿…è¦çš„å‚æ•°ç»™åˆ°ä½¿ç”¨è€…, æ¯”å¦‚æˆ‘è¦åˆ›å»ºä¸€ä¸ªMySQLé«˜å¯ç”¨é›†ç¾¤çš„CRD, æˆ‘å¯ä»¥æŠŠMySQLçš„ç‰ˆæœ¬å·/å‰¯æœ¬æ•°/CPU/ç£ç›˜å¤§å°ç­‰å¸¸è§çš„å‚æ•°æš´éœ²å‡ºæ¥, å…¶å®ƒä¸€äº›å¤æ‚çš„ä¸å¸¸ç”¨çš„éƒ½ç»™éšè—æ‰.



ç„¶åæˆ‘å†™ä¸€ä¸ªControllersæ¥å¹²å…·ä½“çš„äº‹å„¿, Controllerså°±æ˜¯å¾ªç¯ç›‘å¬API Server, çœ‹çœ‹æœ‰æ²¡æœ‰è·Ÿä¸Šè¿°CRDç›¸å…³çš„å˜æ›´äº‹ä»¶, æ¯”å¦‚åˆ›å»º/åˆ é™¤ç­‰, ç„¶åæ¥å¹²æ´». ç¤ºä¾‹å¦‚ä¸‹:



```

// æœ¬è´¨å¦‚ä¸‹
while True:
    desired_state = get_desired_state()
    current_state = get_current_state()
    if desired_state != current_state:
        make_changes_to_reach_desired_state()
```



å…·ä½“ç¤ºä¾‹:



```python
from kubernetes import client, config, watch

def create_configmap(namespace, name, data):
    core_v1_api = client.CoreV1Api()

    configmap = client.V1ConfigMap(
        metadata=client.V1ObjectMeta(namespace=namespace, name=name),
        data=data
    )

    core_v1_api.create_namespaced_config_map(namespace=namespace, body=configmap)

def delete_configmap(namespace, name):
    core_v1_api = client.CoreV1Api()
    core_v1_api.delete_namespaced_config_map(name=name, namespace=namespace)

def main():
    config.load_incluster_config()  # Use in-cluster configuration
    api_instance = client.CustomObjectsApi()
    group = "anvesh.com"  # Update to the correct API group
    version = "v1"  # Update to the correct API version
    namespace = "default"  # Assuming custom resource is in default namespace
    plural = "customconfigmaps"  # Update to the correct plural form of your custom resource

    # Watch for events on custom resource
    resource_version = ""
    while True:
        stream = watch.Watch().stream(
            api_instance.list_namespaced_custom_object,
            group, version, namespace, plural,
            resource_version=resource_version
        )
        for event in stream:
            custom_resource = event['object']
            event_type = event['type']

            # Extract custom resource name
            resource_name = custom_resource['metadata']['name']

            # Extract key-value pairs from the custom resource spec
            resource_data = custom_resource.get('spec', {})

            # Handle events of type ADDED (resource created)
            if event_type == "ADDED":
                create_configmap(namespace=namespace, name=resource_name, data=resource_data)
            # Handle events of type DELETED (resource deleted)
            elif event_type == "DELETED":
                delete_configmap(namespace=namespace, name=resource_name)

            # Update resource_version to resume watching from the last event
            resource_version = custom_resource['metadata']['resourceVersion']

if __name__ == "__main__":
    main()
```



Controllerså¯ä»¥ä½¿ç”¨ä»»ä½•è¯­è¨€ç¼–å†™, ç„¶åå’Œæ­£å¸¸çš„PODä¸€æ ·éƒ¨ç½²åˆ°é›†ç¾¤å°±è¡Œ.



æœ€ç»ˆç”¨æˆ·åªéœ€è¦åˆ›å»ºä¸€ä¸ªCRå°±å¯ä»¥éƒ¨ç½²ä¸€ä¸ªMySQLé›†ç¾¤äº†:



```yaml
apiVersion: mysql-operator.crunchydata.com/v1beta1
kind: MysqlCluster
metadata:
  name: my-mysql
spec:
  instances:
    - name: instance1
      replicas: 2
  backups:
    pgbackrest:
      repos:
        - name: repo1
          volume:
            volumeClaimSpec:
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 1Gi
  users:
    - name: admin
      password:
        type: Password
        value: super-secret

```





#### ğŸš€ å¸¦æ¥çš„å¥½å¤„ï¼š

| æ“ä½œé¡¹   | æ²¡æœ‰ Operator            | ä½¿ç”¨ Operator           |
| -------- | ------------------------ | ----------------------- |
| å®ä¾‹éƒ¨ç½² | æ‰‹åŠ¨å†™ Deployment/YAML   | ä¸€æ¡ CR å³å¯            |
| ä¸»ä»é…ç½® | æ‰‹åŠ¨æ­å»ºå’Œè¿æ¥           | è‡ªåŠ¨é…ç½®                |
| æ•°æ®å¤‡ä»½ | è„šæœ¬ + CronJob ç®¡ç†      | è‡ªåŠ¨è°ƒåº¦ + é…ç½®å¼å®šä¹‰   |
| æ•…éšœè‡ªæ„ˆ | äººå·¥ä»‹å…¥é‡å»ºå‰¯æœ¬         | è‡ªåŠ¨æ£€æµ‹å¤±è´¥å®ä¾‹å¹¶æ‹‰èµ·  |
| ç›‘æ§é›†æˆ | æ‰‹åŠ¨éƒ¨ç½² exporter + Prom | å†…å»º exporterï¼Œè‡ªåŠ¨æ³¨å†Œ |





å…·ä½“çš„é€»è¾‘æœ‰å¯èƒ½æ˜¯éå¸¸å¤æ‚, ä½†æ˜¯åŸºæœ¬é€»è¾‘å°±æ˜¯ä¸Šé¢çš„æƒ…å†µ.



## å‚è€ƒæ–‡æ¡£

* https://github.com/mysql/mysql-operator

* https://dev.mysql.com/doc/mysql-operator/en/mysql-operator-introduction.html

* https://medium.com/@muppedaanvesh/a-hand-on-guide-to-kubernetes-custom-resource-definitions-crds-with-a-practical-example-%EF%B8%8F-84094861e90b

* https://minimaldevops.com/crds-in-kubernetes-c38037315548

  