一次POD流量高的排查经历

收到报警通知有一个pod的流量非常高, pod名称是node_exporter, 因为这个是采集监控数据, 然后prometheus抓取该服务, 按说流量不会太高.

1. 使用iftop查看该该服务器与哪些远端IP的流量交互比较多

因为该服务器是数据库, 与该服务器流量交互比较多的是ceph集群的节点, 这算是正常的, 没有发现异常.

2. 通过nsenter命令抓包具体的POD

nsenter -t <PID> -n tcpdump -i any

找到容器的PID:

docker  ps -a|grep xxx
docker inspect xxxccc

发现抓包的里面大部分都不是跟监控相关的数据, 都是数据库连接相关的数据, 我又确认了一下PID没错啊.

后来我看了一下这个POD的IP, 发现跟宿主机的IP是一样的, 我把这个情况咨询了ChatGPT, 果然真相大白了.

因为node_exporter部署的时候, 配置里面加上了hostNetwork: true, 表示该POD采用了宿主机的网络, 并没有独立分配网络, 所以该POD的网络流量就是整个宿主机的流量.

后来又查了一下这个参数的作用, 这样的话POD的端口就会直接占用宿主机上, 比如9100, 或者Ingress的80/443等

