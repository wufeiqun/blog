## 背景介绍

最近在研究ceph的监控, 突然发现一个令我疑惑的点, 公司的prometheus部署在k8s集群里面, ceph是部署在虚拟机上, 但是从prometheus里面可以查询到ceph相关的监控数据, 这个之前我一直有这个疑惑但是没有详细探究, 正好今天有空仔细考究了一下, 发现了自己之前一直以来的一些知识盲区, 这里记录一下.



## 实现方式

其实Kubernetes里面的prometheus监控虚拟机上的ceph是通过创建了一个Service, 然后该Service指向了外部的ceph服务器的地址.



一般来说我们创建Service的时候都通过selector的方式选择符合标签的POD列表, 这个过程中其实是Kubernetes帮助我们自动创建了一个Endpoints组, 我们修改Deployment的时候, Kubernetes会相应修改Endpoints, Endpoints其实就记录了IP/Port等信息.



其实我们也可以创建Service的时候不写selector, 这样Kubernetes就不会帮我们创建Endpoints分组, 然后我们自己创建Endpoints分组, 然后地址写成虚拟机的IP/Port就行. 因为Endpoints是一个大的分组, 当IP地址变多的时候, 不太好维护, 所以Kubernetes新版本中已经逐渐不使用这个了, 都是用EndpointSlice, 这个会自动分组, 每个组默认最多100个地址, 用法大体一样.

```yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app: server-abc
  name: server-abc
  namespace: wufeiqun
spec:
  ports:
  - name: ssh
    # 这个端口是别人访问该Service的时候的端口
    port: 22
    protocol: TCP
    # 这个端口是Service转发到后端的服务的端口
    # 可以写具体的端口, 也可以写一个字符串
    # 字符串的话就是后端的Pod/EndpointSlice定义的端口的名称
    targetPort: ssh
  type: ClusterIP
```



```yaml
apiVersion: discovery.k8s.io/v1
kind: EndpointSlice
metadata:
  # by convention, use the name of the Service as a prefix for the name of the EndpointSlice
  name: server-abc-1
  namespace: wufeiqun
  labels:
    # You should set the "kubernetes.io/service-name" label.
    # Set its value to match the name of the Service
    kubernetes.io/service-name: server-abc
addressType: IPv4
ports:
  - name: ssh #
    protocol: TCP
    port: 22
endpoints:
  - addresses:
      - "192.168.1.1"
  #- addresses:
  #    - "172.16.3.181"
```



在集群中就可以通过访问`server-abc.wufeiqun`的方式访问`192.168.1.1`.



## 使用场景



#### 访问外部服务

比如有些服务暂时没有迁移到Kubernetes集群里面, 可以通过这种方式提供一个内部的地址, 这样的好处是等服务迁移到内部以后, 可以直接修改Service的selector, 不需要服务做大量的修改.



#### 监控外部服务 

当然监控外部服务也是访问外部服务的一种. 这样就可以做到统一技术栈了, 就不需要单独在虚拟机上安装一个prometheus实例了, 都采用Kubernetes里面的prometheus来监控, 比如上述案例的ServiceMonitor的方式.