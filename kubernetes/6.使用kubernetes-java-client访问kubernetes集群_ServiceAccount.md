#### èƒŒæ™¯ä»‹ç»

åœ¨åŒ»è¯é­”æ–¹æå®¹å™¨åŒ–çš„æ—¶å€™, ä½¿ç”¨kubernetes Javaå®¢æˆ·ç«¯è®¿é—®é›†ç¾¤æ¥åšä¸€äº›æ“ä½œ, ætokenå°±æäº†2å¤©, è¿™é‡Œè®°å½•ä¸€ä¸‹

#### å…·ä½“æ“ä½œ

> æ‰€æœ‰è¿æ¥k8sçš„æ“ä½œ, æœ€åéƒ½æ˜¯è¿æ¥çš„api server, ä¸ç®¡æ˜¯SDKè¿˜æ˜¯HTTPæ¥å£è¿˜æ˜¯kubectl, æ‰€ä»¥é¦–å…ˆè¦çŸ¥é“api serverçš„åœ°å€, api serverçš„ç«¯å£æ˜¯`6443`, å…¬å¸ä½¿ç”¨çš„æ˜¯rancheræ­å»ºçš„, é»˜è®¤çš„kubeconfigä¸­é“¾æ¥çš„æ˜¯rancherçš„API`8443`ç«¯å£, è¿™å—å°±æäº†2å¤©æ‰ååº”è¿‡æ¥, è¿˜æ˜¯ä½¿ç”¨åŸç”Ÿçš„APIæ¯”è¾ƒå¥½æ§åˆ¶

##### ç¬¬ä¸€æ­¥åˆ›å»ºservice account

service accountå°±æ˜¯ç”¨æ¥è®¤è¯API serverçš„, æˆ‘ä»¬ç¬¬ä¸€æ­¥æ˜¯åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„service account, æœ€å¥½ä¸å¥½æ··ç”¨, ä¸“è´¦å·ä¸“ç”¨, Service Accountæ˜¯åŒºåˆ†å‘½åç©ºé—´çš„, ä¸åŒå‘½åç©ºé—´çš„ServiceAccountä¸èƒ½è·¨å‘½åç©ºé—´è°ƒç”¨, yamlæ–‡ä»¶å¦‚ä¸‹:

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: sre-zeus
  namespace: pharmcube
```

æ‰§è¡Œåˆ›å»ºå‘½ä»¤: `kubectl -f xxx.yaml`

åˆ›å»ºå®Œå‘½åç©ºé—´ä»¥å, 1.24ç‰ˆæœ¬ä¹‹å‰çš„Kubernetesä¼šè‡ªåŠ¨åˆ›å»ºå¹¶ç»‘å®šä¸€ä¸ªsecret, 1.24ä¹‹åçš„ç‰ˆæœ¬ä¸ä¼šè‡ªåŠ¨åˆ›å»º, æŸ¥çœ‹è¯¥service accountå¦‚ä¸‹:

```
apiVersion: v1
kind: ServiceAccount
metadata:
  name: sre-zeus
  namespace: pharmcube
secrets:
  - name: sre-zeus-token-xzb4j
```

æŸ¥çœ‹è¯¥tokenå†…å®¹å¦‚ä¸‹:

```bash
(python3) âœ  kubernetes git:(master) âœ— kubectl describe secret  sre-zeus-token-xzb4j -n pharmcube
Name:         sre-zeus-token-xzb4j
Namespace:    pharmcube
Labels:       <none>
Annotations:  kubernetes.io/service-account.name: sre-zeus
              kubernetes.io/service-account.uid: aa3fe061-b1df-4ff8-bf3a-e0cbb73df25d

Type:  kubernetes.io/service-account-token

Data
====
ca.crt:     1058 bytes
namespace:  9 bytes
token:      eyJhbGciOiJSU......Fl86rwRtMItq7GjPdDfkf5f3SL1zzQ
```

å…¶ä¸­`token`å­—æ®µå°±æ˜¯æˆ‘ä»¬é…ç½®åœ¨SDKä¸­çš„ä¿¡æ¯, é…ç½®å¦‚ä¸‹:

```
kubernetes:
  base-path: https://xxx:6443
  token: eyJhbGciOiJSUzI1NiIs......ImtpZCI6ImIya29acTM
```

ä»£ç å¦‚ä¸‹:

```java
    private CoreV1Api createCoreV1Api(String basePath, String token) {

        ApiClient client = new ClientBuilder().setBasePath(basePath).setVerifyingSsl(false)
                .setAuthentication(new AccessTokenAuthentication(token))
                .setReadTimeout(Duration.ofSeconds(30)).build();

        io.kubernetes.client.openapi.Configuration.setDefaultApiClient(client);

        return new CoreV1Api();
    }
```

åˆ°è¿™é‡Œå…¶å®è´¦å·å·²ç»ç®—æ˜¯åˆ›å»ºäº†, ä½†æ˜¯è¿˜éœ€è¦é…ç½®æƒé™, è¿˜å¥½k8sä½¿ç”¨çš„æ˜¯RBACçš„æƒé™æ§åˆ¶, è¿™ä¸ªä¹Ÿä¸å¤æ‚, å¦‚ä¸‹æ¥ç€æ

##### åˆ›å»ºè§’è‰²å¹¶ç»‘å®šè´¦å·

k8sä¸­æœ‰ä¸¤ç§è§’è‰²çš„æ¦‚å¿µ, ä¸€ä¸ªæ˜¯`Role`, å¦ä¸€ä¸ªæ˜¯`ClusterRole`, `Role`é»˜è®¤æ˜¯åœ¨ä¸€ä¸ª`namespace`ä¸­ç”Ÿæ•ˆçš„, å¦‚æœæƒ³è¦å…¨å±€çš„å°±æ˜¯ç”¨`ClusterRole`, è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨`ClusterRole`,  ç”±äºæˆ‘ä»¬æƒ³è¦æœ€é«˜æƒé™, è¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ç³»ç»Ÿåˆ›å»ºçš„`cluster-admin`çš„è§’è‰²äº†, è§’è‰²ä¸Šå¯ä»¥ç»‘å®šå¯¹å…·ä½“èµ„æºçš„æ“ä½œåŠ¨ä½œ

ä¸‹é¢æˆ‘ä»¬å°±ç»‘å®šç”¨æˆ·åˆ°è¯¥è§’è‰²ä¸Š, å¦‚ä¸‹:

```
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: sre-zeus
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: sre-zeus
  namespace: pharmcube
```

åˆ°æ­¤æˆ‘ä»¬çš„è´¦å·å°±å¯ä»¥å¯¹k8sé›†ç¾¤åšæ‰€æœ‰çš„åŠ¨ä½œäº†

é™¤äº†SDK, ç›´æ¥ä½¿ç”¨APIä¹Ÿæ˜¯å¯ä»¥çš„, å¦‚ä¸‹:

```
curl -k https://127.0.0.1:6443/api/v1/namespaces/default/pods -H "Authorization: Bearer <token xxxx>"
```



å¦‚æœæ˜¯PODä½¿ç”¨çš„è¯, å¯ä»¥åœ¨Deploymenté‡Œé¢ç›´æ¥æŒ‡å®šServiceAccountå³å¯:

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo-app
  namespace: default
spec:
  replicas: 2
  selector:
    matchLabels:
      app: demo-app
  template:
    metadata:
      labels:
        app: demo-app
    spec:
      serviceAccountName: demo-sa   # ğŸ‘ˆ è¿™é‡Œ
      containers:
      - name: app
        image: nginx
```







