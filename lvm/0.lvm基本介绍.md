## LVM基础知识



1. 安装Linux操作系统的时候, 可以使用标准分区, 比如我们常见的/dev/sda, /dev/sdb等; 同时也可以使用LVM的方式的磁盘分区. 前者分区完以后磁盘大小就固定了不能动态调整大小, 如果磁盘满了也不能调整, 所以比较好的方式是采用LVM的分区.

2. 以前我总是看不上LVM技术, 总觉得这个技术有点过时, 后来发现Ceph的底层也用到了LVM, 给我的提醒就是在不了解一个技术的时候不要随便漠视, 看不起等, 要先充分了解后才对该技术评价.

3. 个人笔记本用不到, 毕竟硬盘就一块, 也没必要库容, 服务器创建虚拟机的时候会用到.



最近工作中经常需要动态调整LVM磁盘的大小, LVM里面的很多名词把自己搞蒙了, 所以花点时间研究了一下LVM.

<img width="678" height="381" alt="Image" src="https://github.com/user-attachments/assets/035a8697-ee59-40d9-b6f1-f746b600610b" />

## LVM有啥优点



1. 对于上层系统来说, 可以无感知动态扩缩容.
2. 对于物理硬盘来说, 可以把这些硬盘组成一个大硬盘池子, 然后按需切割使用.
3. 很方便执行快照/克隆等(便于备份/回滚), 这个不常用, 但也算是一个好处
4. LVM就是在实际的硬盘和系统之间加了一层中间层



## LVM基本概念

* PV 指的那些真实的硬盘, 比如/dev/sda, /dev/sdb等等
* VG 指的是在这些PV上创建的一个虚拟分组, 比如下面我安装的系统中的VG名称为rockylinuxvg
* LV VG上划分出来的虚拟磁盘, 可以挂载到不同分区, 比如/, /data等, 比如下面例子中的root是一个LV





## RockyLinux安装的时候如何使用LVM分区



|  挂载点   | 分区类型 | 建议大小 |       文件系统       | 用途                                           |
| :-------: | :------: | :------: | :------------------: | ---------------------------------------------- |
|   /boot   | 标准分区 |   1GB    |         Ext4         | 存放内核与引导文件，必须是标准分区             |
| /boot/efi | 标准分区 |   1GB    | EFI System Partition | 新型引导, 现代大部分都是这种, 必须是vfat格式   |
|     /     | LVM分区  | 按需分配 |         Ext4         | 系统盘, 当然如果没有大文件存储也可以充当数据盘 |

现代的Linux系统一般不创建swap分区, 性能不行, 这里一定要注意把LVM分区放到最后, 不然的话如果夹在/boot中间的话后期还真没办法扩容, 因为LVM扩容需要连续的空间.

安装好以后格式如下:

<img width="1755" height="282" alt="Image" src="https://github.com/user-attachments/assets/adde60e8-445a-438d-855e-46a9f64faacf" />





```
[root@localhost ~]# pvs
  PV             VG           Fmt  Attr PSize   PFree
  /dev/nvme0n1p2 rockylinuxvg lvm2 a--  <18.00g    0
[root@localhost ~]# vgs
  VG           #PV #LV #SN Attr   VSize   VFree
  rockylinuxvg   1   1   0 wz--n- <18.00g    0
[root@localhost ~]# lvs
  LV   VG           Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  root rockylinuxvg -wi-ao---- <18.00g
```





这里我尝试调整一下系统盘LVM的大小, 我的macOS使用VMware做的虚拟机, 调整磁盘大小需要关机, 生产环境PVE是不需要的, 可以动态调整.

因为我的LVM是基于VMware的虚拟磁盘上搞的, VMware已经调整了磁盘大小, 可以通过如下命令看到(从20--->调整到25了):

```
[root@localhost ~]# lsblk
NAME                  MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
sr0                    11:0    1  1.9G  0 rom
nvme0n1               259:0    0   30G  0 disk
├─nvme0n1p1           259:1    0    1G  0 part /boot/efi
├─nvme0n1p2           259:2    0    1G  0 part /boot
└─nvme0n1p3           259:3    0   18G  0 part
  └─rockylinuxvg-root 253:0    0   18G  0 lvm  /
```

但是PV还没有感受到大小的调整, 应该调整PV的大小:

安装growpart工具:

```
yum install cloud-utils-growpart -y
```

扩大LVM的硬盘:

```
[root@localhost ~]# growpart /dev/nvme0n1 3
CHANGED: partition=3 start=4196352 old: size=37744640 end=41940991 new: size=58718175 end=62914526
```

扩容以后:

```
[root@localhost ~]# lsblk
NAME                  MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
sr0                    11:0    1  1.9G  0 rom
nvme0n1               259:0    0   30G  0 disk
├─nvme0n1p1           259:1    0    1G  0 part /boot/efi
├─nvme0n1p2           259:2    0    1G  0 part /boot
└─nvme0n1p3           259:3    0   28G  0 part
  └─rockylinuxvg-root 253:0    0   18G  0 lvm  /
```

扩大PV:

```
[root@localhost ~]# pvresize /dev/nvme0n1p3
  Physical volume "/dev/nvme0n1p3" changed
  1 physical volume(s) resized or updated / 0 physical volume(s) not resized
```

扩大后效果如下, 可以看到有一个PFree 10GB, 刚才就是扩大了10GB:

```
[root@localhost ~]# pvs
  PV             VG           Fmt  Attr PSize   PFree
  /dev/nvme0n1p3 rockylinuxvg lvm2 a--  <28.00g 10.00g
[root@localhost ~]# pvdisplay
  --- Physical volume ---
  PV Name               /dev/nvme0n1p3
  VG Name               rockylinuxvg
  PV Size               <28.00 GiB / not usable 1.98 MiB
  Allocatable           yes
  PE Size               4.00 MiB
  Total PE              7167
  Free PE               2560
  Allocated PE          4607
  PV UUID               lKujJm-P8fK-Bn8o-jId0-z2zt-cdLC-P0v3pu
```

因为该PV属于`rockylinuxvg`这个VG, 我们可以直接查看该VG的一些信息:

```
[root@localhost ~]# vgdisplay
  --- Volume group ---
  VG Name               rockylinuxvg
  System ID
  Format                lvm2
  Metadata Areas        1
  Metadata Sequence No  4
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                1
  Open LV               1
  Max PV                0
  Cur PV                1
  Act PV                1
  VG Size               <28.00 GiB
  PE Size               4.00 MiB
  Total PE              7167
  Alloc PE / Size       4607 / <18.00 GiB
  Free  PE / Size       2560 / 10.00 GiB
  VG UUID               PSxpom-jHeC-TZ0B-EEKH-O9H7-htQr-X3Uao1
```

可以看到Free那块的10GB.



## LVM和Ceph的对比和区别



1. LVM解决<如何在一台机器上动态管理磁盘>; Ceph解决<如何在一堆机器上动态管理磁盘、冗余、网络访问>
2. **LVM本身不提供高可用能力, 依赖底层的硬盘RAID, 如果没有做RAID, 硬盘坏了数据就会丢失**; Ceph本身通过多副本和EC码机制提供高可用能力