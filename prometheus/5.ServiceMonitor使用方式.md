## 背景介绍

在写ServiceMonitor如何使用之前, 我先说一个令我印象深刻的事情, 也是kube-monitor. 我之前做监控一直是手工部署的Prometheus, 并且使用命令行居多, 这个倒也不是问题. 问题是在搞Prometheus的时候, 我对那些社区活跃, 并且封装良好的kube-Prometheus产生了排斥的心理, 也就是认为命令行无敌, 自建的无敌, 因为可以深入了解背后的原理. 直到我到了新公司以后, 新公司使用的kube-prometheus, 我深入学习了以后, 发现这个还挺好用.

这件事情给了我很大的触动, 他让我意识到即使命令行可以让自己充分了解底层的原理, 好用的工具也要多尝试, 对于新技术要保持空杯心态, 多尝试, 只有尝试以后才能确定是否是好, 而不是还没有体验就给贴标签.

kube-prometheus是结合了Kubernetes和Prometheus两个技术, 是Kubernetes的完美监控方案. 它封装了ServiceMonitor和PodMonitor两个对象, 可以做到对Kubernetes里面所有资源的监控. 这里介绍一下ServiceMonitor的使用.

## ServiceMonitor基础使用

ServiceMonitor是prometheus-operator自定义的Kubernetes的CRD, 是用来监控Service对象的, 通过Kubernetes的label机制, 如下是一个很普通的Service:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: java-demo
  namespace: develop
  # 因为ServiceMonitor是通过label来找对应的Service的, 所以Service的label不能省
  labels:
    app: java-demo
spec:
  selector:
    app: java-demo
    serviceType: api
  ports:
    - name: http
      port: 8080
      targetPort: 8080
```

一般情况下我们可以定义一个ServiceMonitor来监控多个Service, 比如监控API接口的所有Service, 也可以为单独某一个Service配置ServiceMonitor, 下面是ServiceMonitor的示例:

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: java-demo
  # 这里要跟Prometheus所在的namespace一致
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app: java-demo
  namespaceSelector:
    any: true
  endpoints:
    # port可以写service里面定义的port名称, 也可以写具体的端口
    - port: http
      path: /metrics
      interval: 60s
```

到这里其实一个简单的配置就算完成了, 这个可以解决大部分的问题了, 当然endpoints下面也可以写具体的relabel规则, 这里不再展开, 有用到的时候可以查看文档.

## 监控集群外部资源

一般公司内部不是所有的服务都会部署到Kubernetes集群里面, 总有一些服务因为历史原因或者服务特点会部署到虚拟机上, 当然可以在虚拟机上搭建一个Prometheus实例, 其实Prometheus也可以支持监控集群外部的服务, 这里记录一下方式, 以后用到也可以直接使用.

这里面的原理是这样的, Kubernetes里面的Service只是一个透传的作用, 它通过label筛选出目标POD, 然后把这些POD组成一个endpoints, 也就是IP:PORT列表, 当访问Service的时候, Kubernetes通过ipvs来转发到endpoints列表里面的地址了.

我们可以自己定义一个Service+EndpointSlice的方式实现(EndpointSlice相比Endpoints性能更好)


这里用监控虚拟机上部署的Ceph集群来说明, 监控Ceph有两个点, 一个是node_exporter暴露的端口来监控服务器, 另一个是Ceph本身的监控接口:

1. 首先定义一个空的Service, 因为我们不需要它去筛选POD, 如下:

```
apiVersion: v1
kind: Service
metadata:
  labels:
    app: ceph-node-exporter
  name: ceph-node-exporter
  namespace: default
spec:
  ports:
  - name: metrics
    port: 9100
    protocol: TCP
    targetPort: 9100
```

2. 定义EndpointSlice, 指定虚拟机的IP端口信息:

```
apiVersion: discovery.k8s.io/v1
kind: EndpointSlice
metadata:
  name: ceph-node-exporter-1
  namespace: default
  labels:
    # 这个value必须跟Service的name一致
    kubernetes.io/service-name: ceph-node-exporter
addressType: IPv4
ports:
  - name: metrics
    protocol: TCP
    port: 9100
endpoints:
  # 这里推荐多个IP写到多个address条目
  - addresses:
      - "192.168.1.1"
  - addresses:
      - "172.16.1.2"
```


3. 配置一个ServiceMonitor:

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: ceph-node-exporter
  namespace: monitoring
spec:
  endpoints:
  - interval: 30s
    path: /metrics
    port: metrics
  namespaceSelector:
    any: true
  selector:
    matchLabels:
      app: ceph-node-exporter

```






## 参考文档

1. https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/user-guides/running-exporters.md
2. https://github.com/wufeiqun/blog/blob/master/kubernetes/27.k8s%E9%9B%86%E7%BE%A4%E5%86%85%E8%AE%BF%E9%97%AE%E9%9B%86%E7%BE%A4%E5%A4%96%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%96%B9%E6%B3%95.md
