## 背景介绍



Prometheus是监控行业事实的标准, Kubernetes也是容器编排的标准. 所以如何使用Prometheus监控Kubernetes是必须学习的, 这里记录一下学习过程.



## 部署Prometheus



`Prometheus-Operator`和`kube-prometheus`的关系就像Linux和CentOS的关系一样. 我们安装还是要安装`kube-prometheus`.



安装之前需要查看跟自己已有的Kubernetes集群版本的匹配, 我这里安装的Kubernetes版本是`v1.33.4`, 部署的kube-prometheus的版本是`release-0.16`.

1.  clone代码
```
 # git clone https://github.com/prometheus-operator/kube-prometheus.git
 # git checkout release-0.16
```

2. 部署

```
kubectl apply --server-side -f manifests/setup
kubectl wait \
    --for condition=Established \
    --all CustomResourceDefinition \
    --namespace=monitoring
kubectl apply -f manifests/
```



3. 替换镜像

默认的镜像在国内都没办法下载, 需要翻墙下载下来并推送到私服, 然后替换镜像地址.



4. 调整网络规则

默认安装好以后, 会配置一些网络规则, 只允许grafana访问prometheus, 所以我们如果要通过NodePort访问prometheus的web界面, 就需要删除这个规则, 使用lens操作即可.



5. 创建NodePort

可以直接修改默认的Service, 改成`NodePort`. 



6. 访问grafana

默认的账号密码为`admin/admin`, 自带了很多的Dashboard.


## 参考

* https://github.com/prometheus-operator/kube-prometheus
* https://docs.youdianzhishi.com/k8s/monitor/operator/install/