## 背景介绍

如果使用云厂商的服务器的话, 一般NTP会自动配置, 如果是自建的IDC机房, 自己安装的服务器的话就需要关注服务器的时间同步问题, 因为有一些接口的签名过期时间会用到本地的时间, 如果服务器的时间不对会影响业务的稳定性, 特别是一些集群的签名.

现在的Linux系统一般使用的是chronyd这个服务来配置NTP的时间同步, 这里简单介绍常见的配置方式.

## chrony配置文件

这里采用RockyLinux9来说明, 一般来说系统会自动安装该服务, 配置文件的位置为`/etc/chrony.conf`. 镜像默认的NTP服务器可能是国外的, 这里可以统一采用国内的, 更加稳定一些, 只需要修改如下:

```
# 用 server 是固定上游、稳定可控；用 pool 是动态池、高可用。
# 生产中一般两者混合用：pool 做冗余，server 做高质量上游。

server ntp.aliyun.com iburst
server ntp.tencent.com iburst
server ntp.ntsc.ac.cn iburst
pool cn.pool.ntp.org iburst
```

## chrony常见操作命令

* 查看运行情况

```
systemctl status chronyd
```

* 查看日志

```
journalctl -f -u chronyd
```

## 常见运维命令

一般来说, 服务器时间不同步的情况比较少见, 至少在我的职业生涯中没出现过Linux服务器的时间同步问题. 这里记录的命令也是从网上摘抄的别人的经验.

* `chronyc tracking`

```
Reference ID    : 771CB7B8 (119.28.183.184)
Stratum         : 3
Ref time (UTC)  : Thu Dec 04 06:47:12 2025
System time     : 88856.695312500 seconds slow of NTP time
Last offset     : +0.000140414 seconds
RMS offset      : 1065.179077148 seconds
Frequency       : 0.011 ppm slow
Residual freq   : -0.001 ppm
Skew            : 0.219 ppm
Root delay      : 0.064143032 seconds
Root dispersion : 0.027790604 seconds
Update interval : 1037.3 seconds
Leap status     : Normal
```

主要关注点:

```
# Normal: 表示上游正常, 已同步, 其他状态的话就需要查看NTP服务的连通性了
# 这里正常的话, 即使服务器时间不对也会自动慢慢调整, 可以通过该命令多次验证
# chrony调整时间是小碎步的形式, 如果时间差距较大, 不会一下调整到位, 除非重启chrony服务
Leap status     : Normal

# 表示当前服务器跟NTP服务器的时间差, ReferenceID后面的IP就是当前使用的NTP服务器
System time     : 888 seconds slow of NTP time
Reference ID    : 771CB7B8 (119.28.183.184)

```


* `chronyc activity`

主要关注节点是否都是在线.

```
[root@server134 ~]# chronyc activity
200 OK
4 sources online
0 sources offline
0 sources doing burst (return to online)
0 sources doing burst (return to offline)
0 sources with unknown address
```


* `chronyc sources -v`

如果上述显示结果不在线, 可以详细查看原因. 该命令自带说明. `*`号的是当前使用的节点.

## 监控报警

* 系统时间延迟或提前报警
```
abs(node_timex_offset_seconds{}) > 60
```

这个最关键, 其它的也有, 需要的时候可以再搜搜.

## 排查思路

* 目标地址ping不通, 正常情况下是可以ping通的.

```
ping ntp.aliyun.com
```

* 网络是否通(UDP 123)

```
nc -v -u ntp.aliyun.com 123
```

