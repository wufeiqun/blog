## 背景介绍

公司的MySQL是在Kubernetes中部署的双主架构, 通过Service对外提供服务, master节点出现问题的时候, service就会指向slave节点, 实现MySQL服务的高可用.

但是service指向slave是通过Kubernetes的label来实现的, 不是真正的负载均衡, 也就是只有客户端重新连接的时候才会连切换后的MySQL节点, 存量的连接还是依旧链接原来的MySQL节点.

这就导致了只要MySQL发生切换, 就会存在两个MySQL节点同时写入的情况, 当写入频率很高并且数据库采用的是自增主键的时候就会出现主键冲突的问题, 也就是客户端同时在两个表中新增了同样的ID, 这样主从同步就会断开, 导致数据不一致, 并且不同连接会继续写入到两个节点上.

这时候只能设置某一个为只读, 然后让业务恢复数据, 那么怎么才能根解这个问题呢?

## 解决方式

* 采用自定义主键, 比如UUID/雪花算法等等.

当服务少的时候, 并且技术团队比较规范的时候, 可以这样来规范, 但是团队变大后, 就没办法强制要求每个人都这么搞了, 特别是有些外采的系统.

* 调整MySQL的自增步伐

主节点配置:
```
auto_increment_increment = 2
auto_increment_offset = 1
```

从节点配置:
```
auto_increment_increment = 2
auto_increment_offset = 2
```

然后重启MySQL即可.

> 即使MySQL里面已经有数据了, 也可以配置, 因为MySQL会自动基于最新的自增ID调整next的ID, 官方文档有说明.

## 参考文档

* [https://dev.mysql.com/doc/refman/5.7/en/replication-options-source.html](https://dev.mysql.com/doc/refman/5.7/en/replication-options-source.html)
