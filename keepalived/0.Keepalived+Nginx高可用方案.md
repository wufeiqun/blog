## 背景介绍

以前一直使用的云服务, 比如服务器/负载均衡等, 最近这个公司没有使用云服务, 都是自建的服务, 之前也一直知道高可用, 只是没有亲自安装部署过, 最近苹果笔记本上可以免费使用VMware虚拟机了, 所以很多技术都可以在自己的笔记本上练手了, 这里把Keepalived和NGINX的方案记录一下.



## 安装Keepalived



```
yum install keepalived -y
```



开机自启动:

```
systemctl enable keepalived
```



## 配置Keepalived



|  主机名   |       IP       |  角色  |
| :-------: | :------------: | :----: |
| Server131 | 192.168.78.131 | MASTER |
| Server132 | 192.168.78.132 | BACKUP |
| Server133 | 192.168.78.133 | BACKUP |

注意: 

```
1. VIP是`192.168.78.130`, 在实际的企业中VIP是需要跟网管申请的.
2. 默认情况下MASTER节点挂了以后, 优先级更高的BACKUP节点会升级为MASTER, 原MASTER节点恢复后会继续成为MASTER.
3. 如果想避免频繁切换, 可以在BACKUP节点上设置nopreempt, 表示该BACKUP升级为MASTER后即使原MASTER恢复, 该BACKUP也会继续担任MASTER, 直到挂了才会再次切换
```







三个服务器的配置大部分都一样, 只有这3处有差异:

```
1. router_id
2. state
3. priority
```





Server131的Keepalived配置文件:

```
# #或者!开头是注释内容
! Configuration File for keepalived

# 全局配置部分，每台机器唯一
global_defs {
    # 标识当前节点的名称，必须唯一, 一般是主机名
    router_id server131
}


# Keepalived 的 VRRP 实例（vrrp_instance）一般通过 优先级（priority） 决定谁是主节点。
# 而 vrrp_script 则允许你定义一个检测逻辑（比如检测某服务端口是否可用, 检查某一个进程是否存在等），
# 当检测失败时自动降低该节点的优先级，从而触发 VRRP 选举 → 主备切换。
#
# 注意事项:
# 1. 检测脚本执行失败权重的变化是一次性的, 不会无限制将权重降低到0, 所以要保证权重降低后的要比正常节点的权重低.
vrrp_script chk_service {
    # 检查脚本的路径
    # Keepalived会判断该脚本的执行状态码, 0表示成功, 非0表示失败
    script "/etc/keepalived/check_nginx.sh"
    # 每隔2秒执行一次
    interval 2
    # 连续执行脚本失败的次数, 防止偶然抖动
    # 连续执行脚本失败2次才会判定为失败
    fall 3
    # 连续执行脚本成功的次数
    rise 3
    # 脚本检测失败时优先级降低20
    weight -20
}

# VRRP 实例配置
vrrp_instance VI_1 {
    # 当前节点角色（MASTER）
    state MASTER
    # 绑定网卡的名称
    interface ens160
    # VRRP组ID(0-255之间)，所有节点必须一致, 多套keepalived的时候会用到, 默认随便一个数字就行
    virtual_router_id 51
    # 优先级，数值越大越优先成为主, 期望哪个节点默认成为主节点的话可以适当大一点
    # 但是也别大太多, 不然即使发生探活失败也不会主从切换
    # 另一个点是不同的节点优先级最好别设置一样, 这样更明确知道主节点出问题后会漂移到哪个备节点
    priority 103
    # 广播心跳间隔（秒）
    advert_int 1

    virtual_ipaddress {
        192.168.78.130               # 漂移的虚拟IP（VIP）
    }

    # 绑定上方定义的健康检查脚本
    track_script {
        chk_service
    }
}
```



Server132配置:

```
# #或者!开头是注释内容
! Configuration File for keepalived

# 全局配置部分，每台机器唯一
global_defs {
    # 标识当前节点的名称，必须唯一, 一般是主机名
    router_id server132
}


# Keepalived 的 VRRP 实例（vrrp_instance）一般通过 优先级（priority） 决定谁是主节点。
# 而 vrrp_script 则允许你定义一个检测逻辑（比如检测某服务端口是否可用, 检查某一个进程是否存在等），
# 当检测失败时自动降低该节点的优先级，从而触发 VRRP 选举 → 主备切换。
#
# 注意事项:
# 1. 检测脚本执行失败权重的变化是一次性的, 不会无限制将权重降低到0, 所以要保证权重降低后的要比正常节点的权重低.
vrrp_script chk_service {
    # 检查脚本的路径
    # Keepalived会判断该脚本的执行状态码, 0表示成功, 非0表示失败
    script "/etc/keepalived/check_nginx.sh"
    # 每隔2秒执行一次
    interval 2
    # 连续执行脚本失败的次数, 防止偶然抖动
    # 连续执行脚本失败2次才会判定为失败
    fall 3
    # 连续执行脚本成功的次数
    rise 3
    # 脚本检测失败时优先级降低20
    weight -20
}

# VRRP 实例配置
vrrp_instance VI_1 {
    # 当前节点角色（MASTER）
    state BACKUP
    # 绑定网卡的名称
    interface ens160
    # VRRP组ID(0-255之间)，所有节点必须一致, 多套keepalived的时候会用到, 默认随便一个数字就行
    virtual_router_id 51
    # 优先级，数值越大越优先成为主, 期望哪个节点默认成为主节点的话可以适当大一点
    # 但是也别大太多, 不然即使发生探活失败也不会主从切换
    # 另一个点是不同的节点优先级最好别设置一样, 这样更明确知道主节点出问题后会漂移到哪个备节点
    priority 102
    # 广播心跳间隔（秒）
    advert_int 1
    # 是否抢占模式, 默认原MASTER恢复会自动切回MASTER
    # nopreempt

    virtual_ipaddress {
        192.168.78.130               # 漂移的虚拟IP（VIP）
    }

    # 绑定上方定义的健康检查脚本
    track_script {
        chk_service
    }
}
```



Server133配置:

```
# #或者!开头是注释内容
! Configuration File for keepalived

# 全局配置部分，每台机器唯一
global_defs {
    # 标识当前节点的名称，必须唯一, 一般是主机名
    router_id server133
}


# Keepalived 的 VRRP 实例（vrrp_instance）一般通过 优先级（priority） 决定谁是主节点。
# 而 vrrp_script 则允许你定义一个检测逻辑（比如检测某服务端口是否可用, 检查某一个进程是否存在等），
# 当检测失败时自动降低该节点的优先级，从而触发 VRRP 选举 → 主备切换。
#
# 注意事项:
# 1. 检测脚本执行失败权重的变化是一次性的, 不会无限制将权重降低到0, 所以要保证权重降低后的要比正常节点的权重低.
vrrp_script chk_service {
    # 检查脚本的路径
    # Keepalived会判断该脚本的执行状态码, 0表示成功, 非0表示失败
    script "/etc/keepalived/check_nginx.sh"
    # 每隔2秒执行一次
    interval 2
    # 连续执行脚本失败的次数, 防止偶然抖动
    # 连续执行脚本失败2次才会判定为失败
    fall 3
    # 连续执行脚本成功的次数
    rise 3
    # 脚本检测失败时优先级降低20
    weight -20
}

# VRRP 实例配置
vrrp_instance VI_1 {
    # 当前节点初始角色
    state BACKUP
    # 绑定网卡的名称
    interface ens160
    # VRRP组ID(0-255之间)，所有节点必须一致, 多套keepalived的时候会用到, 默认随便一个数字就行
    virtual_router_id 51
    # 优先级，数值越大越优先成为主, 期望哪个节点默认成为主节点的话可以适当大一点
    # 但是也别大太多, 不然即使发生探活失败也不会主从切换
    # 另一个点是不同的节点优先级最好别设置一样, 这样更明确知道主节点出问题后会漂移到哪个备节点
    priority 101
    # 广播心跳间隔（秒）
    advert_int 1
    # 是否抢占模式, 默认原MASTER恢复会自动切回MASTER
    # nopreempt

    virtual_ipaddress {
        192.168.78.130               # 漂移的虚拟IP（VIP）
    }

    # 绑定上方定义的健康检查脚本
    track_script {
        chk_service
    }
}
```



检测脚本:

这个脚本适用于使用systemd管理的NGINX, 使用systemd来探活

```

#!/bin/sh
systemctl is-active --quiet nginx

chmod +x /etc/keepalived/check_nginx.sh
```

















